/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * To learn more about Gradle by exploring our Samples at https://docs.gradle.org/8.8/samples
 */
plugins {
    id 'base'
}

def getUserAndGroup() {
    def user = System.getProperty('user.name')
    def group = "root" // Typically, the root group is used, but this can be dynamically determined if necessary
    return [user, group]
}

task installDependencies(type: Exec) {
    description = 'Install Python dependencies'
    commandLine 'pip3', 'install', '-r', 'requirements.txt'
}

task setupService(type: Exec) {
    description = 'Set up systemd service'
    doLast {
        def (user, group) = getUserAndGroup()
        def serviceFile = file('tic-tac-toe.service')
        serviceFile.text = """
        [Unit]
        Description=Tic Tac Toe Flask Application
        After=network.target

        [Service]
        User=${user}
        Group=${group}
        WorkingDirectory=${projectDir}
        ExecStart=/usr/bin/python3 ${projectDir}/app.py
        Restart=always

        [Install]
        WantedBy=multi-user.target
        """
        exec {
            commandLine 'sudo', 'mv', serviceFile.absolutePath, '/etc/systemd/system/tic-tac-toe.service'
        }
        exec {
            commandLine 'sudo', 'systemctl', 'daemon-reload'
        }
        exec {
            commandLine 'sudo', 'systemctl', 'enable', 'tic-tac-toe.service'
        }
        exec {
            commandLine 'sudo', 'systemctl', 'start', 'tic-tac-toe.service'
        }
    }
}

task install {
    dependsOn installDependencies, setupService
}

